import subprocess
import json
from typing import List


class ExtractDomainHarvester:
    def execute(self, domain: str) -> List[str]:
        print("Running theHarvester for the domain:", domain)
        command = ['python3', './libs/TheHarvester/theHarvester/theHarvester.py', '-d', domain, '-b', 'all', '-l',
                   '500', '-v', '-f', 'theharvester_output.json']
        try:
            subprocess.run(command, capture_output=True, text=True, check=True)

            subdomains = []
            try:
                with open('theharvester_output.json', 'r') as file:
                    json_data = json.load(file)
                    for subdomain in json_data['hosts']:
                        if not (':' in subdomain or subdomain.startswith('*.')):
                            subdomains.append(subdomain)
                print("theHarvester output processed successfully")
            except Exception as e:
                raise Exception("Error al cargar o procesar el archivo JSON:", e)

            return subdomains

        except subprocess.CalledProcessError as e:
            raise Exception("Error running theHarvester:", e)
