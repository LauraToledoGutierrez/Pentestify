from NetworkManagement.Domain.GetPortsInterface import GetPortsInterface
from Shared.Domain.PortInfo import PortInfo
import glob
import os
import xml.etree.ElementTree as ET
from typing import List
from Shared.Infrastructure.Postgres.PostgresConnection import PostgresConnection
from Shared.Infrastructure.Postgres.OperationsBD import OperationsBD


class GetPortsExe(GetPortsInterface):

    def execute(self, db_connection: PostgresConnection) -> List[PortInfo]:

        folder = "reports"
        if not os.path.exists(folder):
            os.makedirs(folder)
        files = glob.glob(os.path.join(folder, "/tmp/*.xml"))
        port_info = []
        for file in files:
            tree = ET.parse(file)
            root = tree.getroot()

            for puerto in root.findall('.//port'):
                ip_address = root.find(".//address").get("addr")
                num_puerto = puerto.get('portid')
                protocolo = puerto.get('protocol')
                servicio = puerto.find('.//service')
                nombre_servicio = servicio.get(
                    'name', 'Desconocido') if servicio else 'Desconocido'
                producto_servicio = servicio.get(
                    'product', 'Desconocido') if servicio else 'Desconocido'
                version_servicio = servicio.get(
                    'version', 'Desconocida') if servicio else 'Desconocida'

                OperationsBD(db_connection).save_port_info(
                    PortInfo(ip_address, num_puerto, protocolo, nombre_servicio, producto_servicio, version_servicio))

        return port_info
